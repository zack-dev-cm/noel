# План разработки: Project Noetic Mirror

> Примечание: эта итерация добавляет задачи для mobile UX refresh (UC-02, UC-07, UC-12). Остальная часть плана остаётся без изменений.
> Дополнение: новая итерация добавляет задачи для полноты ответов, надёжности Gemini, метрик и коротких модельных тегов (UC-02, UC-07, UC-08, UC-12).
> Дополнение: новая итерация добавляет команду бота для закрепляемой ссылки TMA в публичном канале (UC-05).

## Последовательность выполнения задач

### Этап 1: Создание структуры и заглушек
- **Задача 1.1** — Скелет монорепо (web/server/worker/shared), базовая конфигурация и UI-макет
  - Юзер-кейсы: UC-01, UC-02
  - Файл описания: `tasks/task_1_1.md`
  - Приоритет: Критичный
  - Зависимости: нет

- **Задача 1.2** — Слой данных и заглушки хранилищ (Postgres/Redis)
  - Юзер-кейсы: UC-02, UC-03, UC-07
  - Файл описания: `tasks/task_1_2.md`
  - Приоритет: Высокий
  - Зависимости: Задача 1.1

- **Задача 1.3** — Базовый E2E (local) с заглушками и визуальной проверкой
  - Юзер-кейсы: UC-01, UC-02
  - Файл описания: `tasks/task_1_3.md`
  - Приоритет: Высокий
  - Зависимости: Задача 1.1

### Этап 2: Реализация основного функционала
- **Задача 2.1** — Auth/consent + валидация initData
  - Юзер-кейсы: UC-01
  - Файл описания: `tasks/task_2_1.md`
  - Приоритет: Критичный
  - Зависимости: Задача 1.1

- **Задача 2.2** — WebSocket стриминг, sequence IDs, reconnect
  - Юзер-кейсы: UC-02, UC-07
  - Файл описания: `tasks/task_2_2.md`
  - Приоритет: Критичный
  - Зависимости: Задача 1.2

- **Задача 3.1** — OpenAI Researcher (Responses API), бюджеты, guardrails
  - Юзер-кейсы: UC-02, UC-06
  - Файл описания: `tasks/task_3_1.md`
  - Приоритет: Высокий
  - Зависимости: Задача 2.2

- **Задача 3.2** — Gemini Subject (3.x), контекст, кеширование
  - Юзер-кейсы: UC-02, UC-06
  - Файл описания: `tasks/task_3_2.md`
  - Приоритет: Высокий
  - Зависимости: Задача 3.1

- **Задача 3.3** — Интервенции, телеметрия, safety thresholds
  - Юзер-кейсы: UC-04, UC-06
  - Файл описания: `tasks/task_3_3.md`
  - Приоритет: Высокий
  - Зависимости: Задача 3.2

### Этап 3: Платежи и бот
- **Задача 4.1** — Telegram Stars платежи, entitlements, receipts
  - Юзер-кейсы: UC-03, UC-04
  - Файл описания: `tasks/task_4_1.md`
  - Приоритет: Критичный
  - Зависимости: Задача 2.1

- **Задача 4.2** — Команды бота и постинг в канал
  - Юзер-кейсы: UC-05
  - Файл описания: `tasks/task_4_2.md`
  - Приоритет: Средний
  - Зависимости: Задача 4.1

### Этап 4: Персистентность и ops
- **Задача 5.1** — Реальная персистентность (Postgres/Redis) + retention job
  - Юзер-кейсы: UC-02, UC-07
  - Файл описания: `tasks/task_5_1.md`
  - Приоритет: Высокий
  - Зависимости: Задача 1.2

- **Задача 6.1** — Observability (структурные логи, трассировка, ops)
  - Юзер-кейсы: UC-06
  - Файл описания: `tasks/task_6_1.md`
  - Приоритет: Средний
  - Зависимости: Задача 5.1

### Этап 5: CI/CD и деплой
- **Задача 7.1** — Docker/Cloud Build, deploy script, runbooks
  - Юзер-кейсы: UC-02
  - Файл описания: `tasks/task_7_1.md`
  - Приоритет: Высокий
  - Зависимости: Задача 5.1

- **Задача 7.2** — GitHub Actions (lint/test/e2e/deploy)
  - Юзер-кейсы: UC-02
  - Файл описания: `tasks/task_7_2.md`
  - Приоритет: Средний
  - Зависимости: Задача 7.1

### Этап 6: QA и релиз
- **Задача 8.1** — Playwright E2E (local + prod) и release loop
  - Юзер-кейсы: UC-01, UC-02, UC-03, UC-04, UC-05, UC-07
  - Файл описания: `tasks/task_8_1.md`
  - Приоритет: Критичный
  - Зависимости: Задача 7.1

### Этап 7: Breath telemetry
- **Задача 9.1** — Breath telemetry pipeline (schema + compute + storage)
  - Юзер-кейсы: UC-08
  - Файл описания: `tasks/task_9_1.md`
  - Приоритет: Высокий
  - Зависимости: Задача 3.3, Задача 5.1

- **Задача 9.2** — Breath UI widget + diagnostics + E2E coverage
  - Юзер-кейсы: UC-08
  - Файл описания: `tasks/task_9_2.md`
  - Приоритет: Средний
  - Зависимости: Задача 9.1

### Этап 8: Admin UI enhancements
- **Задача 10.1** — Display model versions in Admin UI
  - Юзер-кейсы: UC-06
  - Файл описания: `tasks/task_10_1.md`
  - Приоритет: Средний
  - Зависимости: Задача 2.1

### Этап 9: Mobile UX refresh
- **Задача 11.1** — Mobile-native UI, turn pairing, bottom navigation
  - Юзер-кейсы: UC-02, UC-07, UC-12
  - Файл описания: `tasks/task_11_1.md`
  - Приоритет: Высокий
  - Зависимости: Задача 2.2

- **Задача 11.2** — Playwright UI updates + release loop (deploy + e2e)
  - Юзер-кейсы: UC-02, UC-07, UC-12
  - Файл описания: `tasks/task_11_2.md`
  - Приоритет: Высокий
  - Зависимости: Задача 11.1

### Этап 10: Language + Theme + Subject Debugging
- **Задача 12.1** — Preferences + session language storage (DB + API)
  - Юзер-кейсы: UC-09
  - Файл описания: `tasks/task_12_1.md`
  - Приоритет: Высокий
  - Зависимости: Задача 2.1

- **Задача 12.2** — Worker language prompts + Subject logging/fallbacks
  - Юзер-кейсы: UC-09
  - Файл описания: `tasks/task_12_2.md`
  - Приоритет: Высокий
  - Зависимости: Задача 12.1

- **Задача 12.3** — WebApp language/theme toggles + localization
  - Юзер-кейсы: UC-09
  - Файл описания: `tasks/task_12_3.md`
  - Приоритет: Средний
  - Зависимости: Задача 12.1

- **Задача 12.4** — Playwright + deploy debug loop for Subject replies
  - Юзер-кейсы: UC-02, UC-09
  - Файл описания: `tasks/task_12_4.md`
  - Приоритет: Критичный
  - Зависимости: Задача 12.2, Задача 12.3

### Этап 11: Paper Materiality + Custom Typography
- **Задача 13.1** — Paper materiality + custom typography refresh (WebApp)
  - Юзер-кейсы: UC-02, UC-12
  - Файл описания: `tasks/task_13_1.md`
  - Приоритет: Средний
  - Зависимости: Задача 11.1

### Этап 12: Stream + Prompt + UI/UX Refinement
- **Задача 14.1** — Worker service deploy + Subject stream visibility
  - Юзер-кейсы: UC-02
  - Файл описания: `tasks/task_14_1.md`
  - Приоритет: Критичный
  - Зависимости: Задача 12.4

- **Задача 14.2** — Researcher/Subject prompt tuning + language enforcement
  - Юзер-кейсы: UC-02, UC-09
  - Файл описания: `tasks/task_14_2.md`
  - Приоритет: Высокий
  - Зависимости: Задача 12.2

- **Задача 14.3** — UI/UX polish + dark mode contrast + button fixes
  - Юзер-кейсы: UC-02, UC-09, UC-12
  - Файл описания: `tasks/task_14_3.md`
  - Приоритет: Высокий
  - Зависимости: Задача 12.3, Задача 13.1

- **Задача 14.4** — Playwright + deploy debug loop for live Subject replies
  - Юзер-кейсы: UC-02, UC-09
  - Файл описания: `tasks/task_14_4.md`
  - Приоритет: Критичный
  - Зависимости: Задача 14.1, Задача 14.2, Задача 14.3

### Этап 13: Contrast + Telemetry + Admin Access + Budget Caps
- **Задача 15.1** — Dark mode text contrast + turn legibility
  - Юзер-кейсы: UC-02, UC-12
  - Файл описания: `tasks/task_15_1.md`
  - Приоритет: Высокий
  - Зависимости: Задача 14.3

- **Задача 15.2** — Stream telemetry pass-through (metrics populated)
  - Юзер-кейсы: UC-02, UC-08
  - Файл описания: `tasks/task_15_2.md`
  - Приоритет: Высокий
  - Зависимости: Задача 14.1

- **Задача 15.3** — Admin username access + budget caps + model update
  - Юзер-кейсы: UC-06, UC-11
  - Файл описания: `tasks/task_15_3.md`
  - Приоритет: Критичный
  - Зависимости: Задача 12.1

- **Задача 15.4** — Playwright + deploy debug loop for contrast/metrics/admin
  - Юзер-кейсы: UC-02, UC-08, UC-11, UC-12
  - Файл описания: `tasks/task_15_4.md`
  - Приоритет: Критичный
  - Зависимости: Задача 15.1, Задача 15.2, Задача 15.3

### Этап 14: Reply Completeness + Gemini Reliability + Metrics + Model Tags
- **Задача 16.1** — Subject retry (same model) + length targets + output completeness logging
  - Юзер-кейсы: UC-02, UC-08
  - Файл описания: `tasks/task_16_1.md`
  - Приоритет: Критичный
  - Зависимости: Задача 15.2

- **Задача 16.2** — Stream persistence + transcript API + telemetry completeness
  - Юзер-кейсы: UC-02, UC-07, UC-08
  - Файл описания: `tasks/task_16_2.md`
  - Приоритет: Высокий
  - Зависимости: Задача 16.1

- **Задача 16.3** — UI: full-text turns, expand-on-tap logs, short model tags
  - Юзер-кейсы: UC-02, UC-07, UC-12
  - Файл описания: `tasks/task_16_3.md`
  - Приоритет: Высокий
  - Зависимости: Задача 16.2

- **Задача 16.4** — Playwright + deploy/debug loop for replies/metrics/tags
  - Юзер-кейсы: UC-02, UC-07, UC-08, UC-12
  - Файл описания: `tasks/task_16_4.md`
  - Приоритет: Критичный
  - Зависимости: Задача 16.3

### Этап 15: Channel Streaming + Debug Models
- **Задача 17.1** — Stream mirroring to Telegram channel (role labels + chunking)
  - Юзер-кейсы: UC-05
  - Файл описания: `tasks/task_17_1.md`
  - Приоритет: Высокий
  - Зависимости: Задача 16.2

- **Задача 17.2** — Playwright + deploy/debug loop for channel streaming
  - Юзер-кейсы: UC-05
  - Файл описания: `tasks/task_17_2.md`
  - Приоритет: Критичный
  - Зависимости: Задача 17.1

### Этап 16: Закрепляемая ссылка TMA в канале
- **Задача 18.1** — Команда бота для постинга закрепляемой ссылки TMA
  - Юзер-кейсы: UC-05
  - Файл описания: `tasks/task_18_1.md`
  - Приоритет: Средний
  - Зависимости: Задача 4.2

- **Задача 18.2** — Исправление кнопки ссылки TMA для каналов (URL вместо web_app)
  - Юзер-кейсы: UC-05
  - Файл описания: `tasks/task_18_2.md`
  - Приоритет: Высокий
  - Зависимости: Задача 18.1

## Покрытие юзер-кейсов

| Юзер-кейс | Задачи |
|-----------|--------|
| UC-01 | 1.1, 1.3, 2.1, 8.1 |
| UC-02 | 1.1, 1.2, 1.3, 2.2, 3.1, 3.2, 5.1, 7.1, 8.1, 11.1, 11.2, 13.1, 14.1, 14.2, 14.3, 14.4, 15.1, 15.2, 15.4, 16.1, 16.2, 16.3, 16.4 |
| UC-03 | 1.2, 4.1, 8.1 |
| UC-04 | 3.3, 4.1, 8.1 |
| UC-05 | 4.2, 8.1, 17.1, 17.2, 18.1, 18.2 |
| UC-06 | 3.1, 3.2, 3.3, 6.1, 10.1, 15.3 |
| UC-07 | 1.2, 2.2, 5.1, 8.1, 11.1, 11.2, 16.2, 16.3, 16.4 |
| UC-08 | 9.1, 9.2, 15.2, 15.4, 16.1, 16.2, 16.4 |
| UC-12 | 11.1, 11.2, 13.1, 14.3, 15.1, 15.4, 16.3, 16.4 |
| UC-09 | 12.1, 12.2, 12.3, 12.4, 14.2, 14.3, 14.4 |
| UC-11 | 10.1, 15.3, 15.4 |
